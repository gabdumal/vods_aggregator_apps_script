<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Cria um listener para o bot칚o btnAddConteudo, para quando clicar, executar a fun칞칚o addConteudo
    document
      .getElementById("btnAddConteudo")
      .addEventListener("click", addConteudo);
    // Cria um listener para o bot칚o btnEnviar, para quando clicar, executar a fun칞칚o enviarForm
    document.getElementById("btnEnviar").addEventListener("click", enviarForm);
    // Cria um listener para o input linkV, para quando mudar o valor, executar a fun칞칚o extrairCodLink
    document.getElementById("linkV").addEventListener("input", extrairCodLink);

    // Adiciona listeners para dinamizar a datalist
    var inpu = document.getElementById("nomeC1");
    var results = document.getElementById("nomeCDatalist");
    var templateContent = document.getElementById("nomeCTemplate").content;
    inpu.addEventListener("keyup", function handler(event) {
      while (results.children.length) results.removeChild(results.firstChild);
      var inputVal = new RegExp(inpu.value.trim(), "i");
      var set = Array.prototype.reduce.call(
        templateContent.cloneNode(true).children,
        function searchFilter(frag, item, i) {
          if (
            (inputVal.test(item.textContent) || inputVal.test(item.value)) &&
            frag.children.length < 6
          )
            frag.appendChild(item);
          return frag;
        },
        document.createDocumentFragment()
      );
      results.appendChild(set);
    });
  });

  function enviarForm() {
    // Define uma vari치vel de erros
    var erros = "";

    // Define vari치veis e as preenche com os elementos do formul치rio obtidos por seus IDs
    var numV = document.getElementById("numV");
    var stsV = document.getElementById("stsV");
    var titV = document.getElementById("titV").value;
    var linkV = document.getElementById("linkV");
    var obsV = document.getElementById("obsV");
    var partV = document.getElementById("partV");
    var stsC1 = document.getElementById("stsC1");
    var nomeC1 = document.getElementById("nomeC1");
    var mutC1 = document.getElementById("mutC1");

    // Verifica se os valores do n칰mero, status e t칤tulo da live foram preenchidos segundo os par칙metros
    // Caso contr치rio, adiciona o elemento com problemas de preenchimento  vari치vel de erros
    if (numV.value) {
    } else {
      erros += "N칰mero do Vod\n";
    }
    if (
      stsV.value === "N" ||
      stsV.value === "P" ||
      stsV.value === "I" ||
      stsV.value === "C"
    ) {
    } else {
      erros += "Status\n";
    }
    if (!titV) {
      erros += "T칤tulo\n";
    } else {
      if (titV.charAt(0) === "'") {
        titV = "'" + titV;
      }
    }

    // Define uma vari치vel com o valor do c칩digo extra칤do do link digitado no formul치rio
    codV = extrairCodLink();
    // Caso o tamanho do c칩digo do Vod n칚o esteja ente 9 e 10 (tamanho esperado), adiciona Link  vari치vel de erros
    if (codV.length < 9 || codV.length > 10) {
      erros += "Link\n";
    }

    // Define vari치veis de NodeList, que guardam todos os elementos com os nomes stsC, nomeC e mutC
    var listaStsC = document.getElementsByName("stsC[]");
    var listaNomeC = document.getElementsByName("nomeC[]");
    var listaMutC = document.getElementsByName("mutC[]");

    // Declara uma lista de objetos Conteudo
    var listaConteudos = [];

    // Define vari치vel de erro de conte칰dos
    var errosC = "";

    // Para cada linha de Conteudo do formul치rio...
    for (var i = 0; i < listaNomeC.length; i++) {
      // Define a vari치vel de nome do conte칰do com o valor da sua linha correspondente preenchida no formul치rio
      var nomeCVal = listaNomeC[i].value;
      //  Se o tamanho do nome for maior que 0 (se ele estiver preenchido)...
      if (nomeCVal.length > 0) {
        // Declara um objeto de Conteudo
        var conteudoData = {};
        // Define vari치veis com os valores dos select de status e mutado da linha de conte칰do
        var stsCVal = listaStsC[i].value;
        var mutCVal = listaMutC[i].value;
        // Verifica se os valores dos selects obtidos est칚o dentro do padr칚o esperado
        // Caso contr치rio, adiciona o erro  vari치vel de erro de conte칰dos
        if (
          stsCVal === "N" ||
          stsCVal === "P" ||
          stsCVal === "I" ||
          stsCVal === "C"
        ) {
        } else {
          errosC += "Status do conte칰do " + (i + 1) + "\n";
        }
        if (mutCVal === "N" || mutCVal === "S" || mutCVal === "P") {
        } else {
          errosC += "Mute do conte칰do " + (i + 1) + "\n";
        }
        // Caso n칚o haja erros de conte칰do...
        if (errosC === "") {
          // Define atributos do objeto Conteudo com os valores da linha correspondente preenchida no formul치rio
          conteudoData.sts = stsCVal;
          conteudoData.nome = nomeCVal;
          conteudoData.mut = mutCVal;
          // Adiciona o objeto Conteudo  lista de objetos Conteudo
          listaConteudos.push(conteudoData);
        } else {
          // Caso contr치rio...
          // Adiciona as vari치veis de erro de conte칰do  vari치vel de erro geral
          erros += errosC;
          // Define o valor da vari치vel de erros de conte칰do como string vazia
          errosC = "";
        }
      }
    }
    // Verifica se h치 algum conte칰do preenchido. Caso contr치rio, adiciona esse erro  vari치vel de erros
    if (listaConteudos.length < 1) {
      erros += "Nenhum conte칰do foi preenchido corretamente\n";
    }

    // Caso n칚o haja erros...
    if (erros === "") {
      // Declara um objeto de Vod
      var vodData = {};
      // Define o atributo cod do objeto Vod com os valores preenchidos no formul치rio
      vodData.cod = codV;
      // Define atributos do objeto Vod com os valores preenchidos no formul치rio
      vodData.num = numV.value;
      vodData.sts = stsV.value;
      vodData.tit = titV;
      vodData.obs = obsV.value;
      vodData.part = partV.value;

      // Executa a fun칞칚o de adicionar as informa칞칫es do Vod e Conteudos  Spreadsheet
      google.script.run.addVodSs(vodData, listaConteudos);

      setTimeout(function () {
        var loadingDiv = document.getElementById("loadingDiv");
        loadingDiv.style.display = "flex";
        // Exibe um alert informando que a opera칞칚o foi realizada com sucesso
        alert(
          "A inclus칚o do Vod " +
            vodData.num +
            " no sistema foi realizada com sucesso!"
        );
        loadingDiv.innerHTML =
          '<div class="card d-flex justify-content-center">' +
          '<div class="card-body text-center">' +
          '<div class="row"><span class="">A edi칞칚o do Vod ' +
          vodData.num +
          " no sistema foi realizada com sucesso!</span></div>" +
          '<div class="row"><span>Retornar para a ' +
          '<a href="' +
          url +
          '" ' +
          'class="text-decoration-none fw-bold" style="color: #FF3D6C">P치gina Inicial</a>.</span>' +
          "</div></div>" +
          "</div>";
        window.top.location.href = url;
      }, 1000);

      // Limpa e define os valores dos campos do formul치rio para o padr칚o
      /*
        numV.value = "";
        stsV.value = "P";
        titV.value = "";
        linkV.value = "";
        obsV.value = "";
        partV.value = "";
        stsC1.value = "P";
        nomeC1.value = "";
        mutC1.value = "N";
        */
      // Exclui todas as linhas adicionadas de Conte칰do do formul치rio
      //document.querySelectorAll('.divLinhaConteudo').forEach(e => e.remove());
    } else {
      // Caso haja erros...
      // Exibe os erros em um alert
      alert("H치 erros no preenchimento do formul치rio:\n" + erros.slice(0, -1));
      // Define o valor da vari치vel de erros como string vazia
      erros = "";
    }
  }

  // Extrai o c칩digo do Vod do Link digitado no formul치rio e atualiza o preview do c칩digo
  function extrairCodLink() {
    // Define uma vari치vel com o valor do link digitado no formul치rio
    var linkV = document.getElementById("linkV").value;
    // Define uma string que recupera o c칩digo do Vod a partir do link digitado
    var codV = linkV.substring(
      linkV.lastIndexOf("/") + 1,
      linkV.lastIndexOf("/") + 11
    );
    // Substitui todos os caracteres que n칚o s칚o num칠ricos por um caractere vazio
    codV = codV.replace(/\D/g, "");
    // Define o texto do preview do c칩digo como c칩digo extra칤do
    document.getElementById("codVPreview").innerHTML = codV;
    // Retorna o codV
    return codV;
  }

  // Ao clicar no bot칚o de adicionar conte칰do, adiciona mais uma linha com os inputs de status e nome do conte칰do, al칠m de um bot칚o para remover essa linha
  function addConteudo() {
    var cardBody = document.getElementById("cardListaConteudos");

    // Cria os elementos da linha de input de conte칰do
    var div1 = document.createElement("div");
    var div2 = document.createElement("div");
    var div3 = document.createElement("div");
    var div4 = document.createElement("div");
    var sel1 = document.createElement("select");
    var opt1 = document.createElement("option");
    var opt2 = document.createElement("option");
    var opt3 = document.createElement("option");
    var opt4 = document.createElement("option");
    var inpu = document.createElement("input");
    var div5 = document.createElement("div");
    var sel2 = document.createElement("select");
    var opt5 = document.createElement("option");
    var opt6 = document.createElement("option");
    var opt7 = document.createElement("option");
    var butt = document.createElement("button");

    // Define propriedades dos elementos criados
    sel1.setAttribute("name", "stsC[]");
    opt1.setAttribute("value", "N");
    opt1.setAttribute("selected", "selected");
    opt2.setAttribute("value", "P");
    opt3.setAttribute("value", "I");
    opt4.setAttribute("value", "C");
    inpu.setAttribute("name", "nomeC[]");
    inpu.setAttribute("type", "text");
    inpu.setAttribute("list", "nomeCDatalist");
    inpu.setAttribute("placeholder", "Conte칰do");
    inpu.setAttribute("maxlength", "500");
    sel2.setAttribute("name", "mutC[]");
    opt5.setAttribute("selected", "selected");
    opt5.setAttribute("value", "N");
    opt6.setAttribute("value", "S");
    opt7.setAttribute("value", "P");
    butt.setAttribute("type", "button");

    // Define as classes dos elementos criados
    div1.classList.add("form-row", "mb-3", "divLinhaConteudo");
    div2.classList.add("form-group", "col-md", "mb-0", "conteudoInputRow");
    div3.classList.add("input-group");
    div3.classList.add("input-group-sm");
    div4.classList.add("input-group-prepend");
    sel1.classList.add("form-select");
    opt1.classList.add("text-danger");
    opt2.classList.add("text-warning");
    opt3.classList.add("text-primary");
    opt4.classList.add("text-success");
    inpu.classList.add("form-control", "nomeC");
    div5.classList.add("input-group-append");
    sel2.classList.add("form-select");
    opt5.classList.add("text-primary");
    opt6.classList.add("text-danger");
    opt7.classList.add("text-warning");
    butt.classList.add("btn", "btn-danger", "btnRemoveConteudo");

    // Define o conte칰do dos elementos criados
    opt1.textContent = "游댮";
    opt2.textContent = "游리";
    opt3.textContent = "游댯";
    opt4.textContent = "游릭";
    opt5.textContent = "游댉";
    opt6.textContent = "游댆";
    opt7.textContent = "游댇";
    butt.textContent = "x";

    // Define elementos como filhos de outros elementos apropriados
    cardBody.appendChild(div1);
    div1.appendChild(div2);
    div2.appendChild(div3);
    div3.appendChild(div4);
    div4.appendChild(sel1);
    sel1.appendChild(opt1);
    sel1.appendChild(opt2);
    sel1.appendChild(opt3);
    sel1.appendChild(opt4);
    div3.appendChild(inpu);
    div3.appendChild(div5);
    div5.appendChild(sel2);
    sel2.appendChild(opt5);
    sel2.appendChild(opt6);
    sel2.appendChild(opt7);
    div3.appendChild(butt);

    // Adiciona listener ao bot칚o de excluir
    butt.addEventListener("click", removeConteudo);

    // Adiciona listeners para dinamizar a datalist
    var results = document.getElementById("nomeCDatalist");
    var templateContent = document.getElementById("nomeCTemplate").content;
    inpu.addEventListener("keyup", function handler(event) {
      while (results.children.length) results.removeChild(results.firstChild);
      var inputVal = new RegExp(inpu.value.trim(), "i");
      var set = Array.prototype.reduce.call(
        templateContent.cloneNode(true).children,
        function searchFilter(frag, item, i) {
          if (inputVal.test(item.textContent) && frag.children.length < 6)
            frag.appendChild(item);
          return frag;
        },
        document.createDocumentFragment()
      );
      results.appendChild(set);
    });
  }

  function removeConteudo(e) {
    e.target.parentElement.parentElement.parentElement.remove();
  }
</script>
