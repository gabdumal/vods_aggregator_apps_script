<script>
  let pageUrl = "";
  function getUrl() {
    google.script.run
      .withSuccessHandler(function (url) {
        pageUrl = url;
      })
      .getScriptUrl();
  }
  getUrl();
  let numVod = 0;

  document.addEventListener("DOMContentLoaded", function () {
    // Obt칠m dados de um Vod da Spreadsheet procurando-o por seu ID, e preenche os campos do formul치rio
    addContent();
    const stsC1D = document.getElementsByName("stsC[]")[0];
    stsC1D.setAttribute("disabled", "disabled");
    const nameC1D = stsC1D.parentElement.nextElementSibling;
    nameC1D.setAttribute("disabled", "disabled");
    const mutC1D = nameC1D.nextElementSibling.firstElementChild;
    mutC1D.setAttribute("disabled", "disabled");
    const buttC1D = mutC1D.parentElement.nextElementSibling;
    buttC1D.setAttribute("disabled", "disabled");

    google.script.run.withSuccessHandler(fillForm).getVodDataById(idPag);
    document
      .getElementById("btnAddContent")
      .addEventListener("click", addContent);
    document.getElementById("btnDelete").addEventListener("click", deleteVod);
    document.getElementById("btnSubmit").addEventListener("click", submitForm);
    document.getElementById("linkV").addEventListener("input", extractCodLink);
  });

  function fillForm(vodData) {
    if (vodData[0] !== "#N/A") {
      // Define constantes e as preenche com os elementos do formul치rio obtidos por seus IDs
      const numV = document.getElementById("numV");
      const stsV = document.getElementById("stsV");
      const titV = document.getElementById("titV");
      const linkV = document.getElementById("linkV");
      const obsV = document.getElementById("obsV");
      const partV = document.getElementById("partV");
      const stsC1 = document.getElementsByName("stsC[]")[0];
      const nameC1 = document.getElementsByName("nameC[]")[0];
      const mutC1 = document.getElementsByName("mutC[]")[0];
      // Define os valores dos elementos da p치gina de acordo com os dados do Vod
      document.getElementById("numVodTit").textContent = vodData[1];
      numV.value = vodData[1];
      numVod = vodData[1];
      stsV.value = vodData[2];
      titV.value = vodData[3];
      linkV.value = vodData[4];
      extractCodLink();
      obsV.value = vodData[5];
      partV.value = vodData[6];
      stsC1.value = vodData[7][0][2];
      nameC1.value = vodData[7][0][3];
      mutC1.value = vodData[7][0][4];
      var conteudoData = vodData[7];
      const stsCi = document.getElementsByName("stsC[]");
      const nameCi = document.getElementsByName("nameC[]");
      const mutCi = document.getElementsByName("mutC[]");
      for (i = 1; i < conteudoData.length; i++) {
        addContent();
        stsCi[i].value = conteudoData[i][2];
        nameCi[i].value = conteudoData[i][3];
        mutCi[i].value = conteudoData[i][4];
      }
      unlockPage();
    } else {
      loadingDiv.innerHTML = "";
      const lDiv1 = document.createElement("div");
      lDiv1.className = "card d-flex justify-content-center";
      const lDiv2 = document.createElement("div");
      lDiv2.className = "card-body text-center";
      const lDiv3a = document.createElement("div");
      lDiv3a.className = "row";
      const lSpana = document.createElement("span");
      lSpana.textContent =
        "O Vod que voc칡 tentou acessar n칚o existe no sistema.";
      lDiv3a.appendChild(lSpana);
      lDiv2.appendChild(lDiv3a);
      const lDiv3b = document.createElement("div");
      lDiv3b.className = "row";
      const lSpanb = document.createElement("span");
      lSpanb.appendChild(document.createTextNode("Retornar para a "));
      const lA = document.createElement("a");
      lA.setAttribute("href", pageUrl);
      lA.classList = "text-decoration-none fw-bold text-cherry";
      lA.textContent = "P치gina Inicial";
      lSpanb.appendChild(lA);
      lSpanb.appendChild(document.createTextNode("."));
      lDiv3b.appendChild(lSpanb);
      lDiv2.appendChild(lDiv3b);
      lDiv1.appendChild(lDiv2);
      loadingDiv.textContent = "";
      loadingDiv.appendChild(lDiv1);
      window.top.location.href = pageUrl;
    }
  }

  function submitForm() {
    let errors = "";

    // Define constantes e as preenche com os elementos do formul치rio obtidos por seus IDs
    const numV = document.getElementById("numV");
    const stsV = document.getElementById("stsV");
    let titV = document.getElementById("titV").value;
    const linkV = document.getElementById("linkV");
    const obsV = document.getElementById("obsV");
    const partV = document.getElementById("partV");
    const stsC1 = document.getElementById("stsC1");
    const nameC1 = document.getElementById("nameC1");
    const mutC1 = document.getElementById("mutC1");

    // Verifica se os valores do n칰mero, status e t칤tulo da live foram preenchidos segundo os par칙metros
    // Caso contr치rio, adiciona o elemento com problemas de preenchimento  vari치vel de erros
    if (numV.value) {
    } else {
      errors += "N칰mero do Vod\n";
    }
    if (
      stsV.value === "N" ||
      stsV.value === "P" ||
      stsV.value === "I" ||
      stsV.value === "C"
    ) {
    } else {
      errors += "Status\n";
    }
    if (!titV) {
      errors += "T칤tulo\n";
    } else {
      if (titV.charAt(0) === "'") {
        titV = "'" + titV;
      }
    }

    const codV = extractCodLink();
    // Caso o tamanho do c칩digo do Vod n칚o esteja ente 9 e 10 (tamanho esperado), adiciona Link  vari치vel de erros
    if (codV.length < 9 || codV.length > 10) {
      errors += "Link\n";
    }

    const listStsC = document.getElementsByName("stsC[]");
    const listNameC = document.getElementsByName("nameC[]");
    const listMutC = document.getElementsByName("mutC[]");

    const contentsList = [];

    // Define vari치vel de erro de conte칰dos
    let errorsC = "";

    for (let i = 0; i < listNameC.length; i++) {
      const nameCVal = listNameC[i].value;
      if (nameCVal.length > 0) {
        const contentData = {};
        const stsCVal = listStsC[i].value;
        const mutCVal = listMutC[i].value;
        // Verifica se os valores dos selects obtidos est칚o dentro do padr칚o esperado
        // Caso contr치rio, adiciona o erro  vari치vel de erro de conte칰dos
        if (
          stsCVal === "N" ||
          stsCVal === "P" ||
          stsCVal === "I" ||
          stsCVal === "C"
        ) {
        } else {
          errorsC += "Status do conte칰do " + (i + 1) + "\n";
        }
        if (mutCVal === "N" || mutCVal === "S" || mutCVal === "P") {
        } else {
          errorsC += "Mute do conte칰do " + (i + 1) + "\n";
        }
        // Caso n칚o haja erros de conte칰do...
        if (errorsC === "") {
          // Define atributos do objeto Conte칰do com os valores da linha correspondente preenchida no formul치rio
          contentData.sts = stsCVal;
          contentData.nome = nameCVal;
          contentData.mut = mutCVal;
          contentsList.push(contentData);
        } else {
          // Caso contr치rio...
          // Adiciona as vari치veis de erro de conte칰do  vari치vel de erro geral
          errors += errorsC;
          // Define o valor da vari치vel de erros de conte칰do como string vazia
          errorsC = "";
        }
      }
    }
    // Verifica se h치 algum conte칰do preenchido. Caso contr치rio, adiciona esse erro  vari치vel de erros
    if (contentsList.length < 1) {
      errors += "Nenhum conte칰do foi preenchido corretamente\n";
    }

    // Caso n칚o haja erros...
    if (errors === "") {
      const vodData = {};
      vodData.cod = codV;
      vodData.num = numV.value;
      vodData.sts = stsV.value;
      vodData.tit = titV;
      vodData.obs = obsV.value;
      vodData.part = partV.value;

      // Executa a fun칞칚o de adicionar as informa칞칫es do Vod e Conte칰dos  Spreadsheet
      const loadingDiv = document.getElementById("loadingDiv");
      loadingDiv.style.display = "flex";

      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .editVodSs(vodData, contentsList);

      function onSuccess() {
        // Exibe um alert informando que a opera칞칚o foi realizada com sucesso
        const lDiv1 = document.createElement("div");
        lDiv1.className = "card d-flex justify-content-center";
        const lDiv2 = document.createElement("div");
        lDiv2.className = "card-body text-center";
        const lDiv3a = document.createElement("div");
        lDiv3a.className = "row";
        const lSpana = document.createElement("span");
        lSpana.textContent =
          "A edi칞칚o do Vod " +
          vodData.num +
          " no sistema foi realizada com sucesso!";
        lDiv3a.appendChild(lSpana);
        lDiv2.appendChild(lDiv3a);
        const lDiv3b = document.createElement("div");
        lDiv3b.className = "row";
        const lSpanb = document.createElement("span");
        lSpanb.appendChild(document.createTextNode("Retornar para a "));
        const lA = document.createElement("a");
        lA.setAttribute("href", pageUrl);
        lA.classList = "text-decoration-none fw-bold text-cherry";
        lA.textContent = "P치gina Inicial";
        lSpanb.appendChild(lA);
        lSpanb.appendChild(document.createTextNode("."));
        lDiv3b.appendChild(lSpanb);
        lDiv2.appendChild(lDiv3b);
        lDiv1.appendChild(lDiv2);
        loadingDiv.textContent = "";
        loadingDiv.appendChild(lDiv1);
        window.top.location.href = pageUrl;
      }

      function onFailure() {
        alert(
          "Infelizmente n칚o foi poss칤vel editar o Vod no sistema, tente novamente."
        );
        loadingDiv.style.display = "none";
      }

      // Limpa e define os valores dos campos do formul치rio para o padr칚o
      // numV.value = "";
      // stsV.value = "P";
      // titV.value = "";
      // linkV.value = "";
      // obsV.value = "";
      // partV.value = "";
      // stsC1.value = "P";
      // nameC1.value = "";
      // mutC1.value = "N";
      // Exclui todas as linhas adicionadas de Conte칰do do formul치rio
      //document.querySelectorAll('.divLinhaConteudo').forEach(e => e.remove());
    } else {
      // Caso haja erros...
      // Exibe os erros em um alert
      alert(
        "H치 errors no preenchimento do formul치rio:\n" + errors.slice(0, -1)
      );
      // Define o valor da vari치vel de errors como string vazia
      errors = "";
    }
  }

  // Extrai o c칩digo do Vod do Link digitado no formul치rio e atualiza o preview do c칩digo
  function extractCodLink() {
    const linkV = document.getElementById("linkV").value;
    // Define uma string que recupera o c칩digo do Vod a partir do link digitado
    let codV = linkV.substring(
      linkV.lastIndexOf("/") + 1,
      linkV.lastIndexOf("/") + 11
    );
    // Substitui todos os caracteres que n칚o s칚o num칠ricos por um caractere vazio
    codV = codV.replace(/\D/g, "");
    document.getElementById("codVPreview").textContent = codV;
    return codV;
  }

  // Ao clicar no bot칚o de adicionar conte칰do, adiciona mais uma linha com os inputs de status e nome do conte칰do, al칠m de um bot칚o para remover essa linha
  function addContent() {
    const cardBody = document.getElementById("contentListCard");

    // Cria os elementos da linha de input de conte칰do
    const div1 = document.createElement("div");
    const div2 = document.createElement("div");
    const div3 = document.createElement("div");
    const div4 = document.createElement("div");
    const sel1 = document.createElement("select");
    const opt1 = document.createElement("option");
    const opt2 = document.createElement("option");
    const opt3 = document.createElement("option");
    const opt4 = document.createElement("option");
    const inpu = document.createElement("input");
    const div5 = document.createElement("div");
    const sel2 = document.createElement("select");
    const opt5 = document.createElement("option");
    const opt6 = document.createElement("option");
    const opt7 = document.createElement("option");
    const butt = document.createElement("button");

    // Define propriedades dos elementos criados
    sel1.setAttribute("name", "stsC[]");
    opt1.setAttribute("value", "N");
    opt1.setAttribute("selected", "selected");
    opt2.setAttribute("value", "P");
    opt3.setAttribute("value", "I");
    opt4.setAttribute("value", "C");
    inpu.setAttribute("name", "nameC[]");
    inpu.setAttribute("type", "text");
    inpu.setAttribute("list", "nameCDatalist");
    inpu.setAttribute("placeholder", "Conte칰do");
    inpu.setAttribute("maxlength", "500");
    inpu.setAttribute("disabled", "disabled");
    sel2.setAttribute("name", "mutC[]");
    opt5.setAttribute("selected", "selected");
    opt5.setAttribute("value", "N");
    opt6.setAttribute("value", "S");
    opt7.setAttribute("value", "P");
    butt.setAttribute("type", "button");

    // Define as classes dos elementos criados
    div1.classList.add("form-row", "mb-3", "divLinhaConteudo");
    div2.classList.add("form-group", "col-md", "mb-0", "conteudoInputRow");
    div3.classList.add("input-group");
    div3.classList.add("input-group-sm");
    div4.classList.add("input-group-prepend");
    sel1.classList.add("form-select");
    opt1.classList.add("text-danger");
    opt2.classList.add("text-warning");
    opt3.classList.add("text-primary");
    opt4.classList.add("text-success");
    inpu.classList.add("form-control", "nameC");
    div5.classList.add("input-group-append");
    sel2.classList.add("form-select");
    opt5.classList.add("text-primary");
    opt6.classList.add("text-danger");
    opt7.classList.add("text-warning");
    butt.classList.add("btn", "btn-danger", "btnRemoveContent");

    // Define o conte칰do dos elementos criados
    opt1.textContent = "游댮";
    opt2.textContent = "游리";
    opt3.textContent = "游댯";
    opt4.textContent = "游릭";
    opt5.textContent = "游댉";
    opt6.textContent = "游댆";
    opt7.textContent = "游댇";
    butt.textContent = "x";

    // Define elementos como filhos de outros elementos apropriados
    cardBody.appendChild(div1);
    div1.appendChild(div2);
    div2.appendChild(div3);
    div3.appendChild(div4);
    div4.appendChild(sel1);
    sel1.appendChild(opt1);
    sel1.appendChild(opt2);
    sel1.appendChild(opt3);
    sel1.appendChild(opt4);
    div3.appendChild(inpu);
    div3.appendChild(div5);
    div5.appendChild(sel2);
    sel2.appendChild(opt5);
    sel2.appendChild(opt6);
    sel2.appendChild(opt7);
    div3.appendChild(butt);

    // Adiciona listener ao bot칚o de excluir
    butt.addEventListener("click", removeContent);

    // Adiciona listeners para dinamizar a datalist
    const results = document.getElementById("nameCDatalist");
    const templateContent = document.getElementById("nameCTemplate").content;
    inpu.addEventListener("keyup", function handler(event) {
      while (results.children.length) results.removeChild(results.firstChild);
      const inputVal = new RegExp(inpu.value.trim(), "i");
      const set = Array.prototype.reduce.call(
        templateContent.cloneNode(true).children,
        function searchFilter(frag, item, i) {
          if (inputVal.test(item.textContent) && frag.children.length < 6)
            frag.appendChild(item);
          return frag;
        },
        document.createDocumentFragment()
      );
      results.appendChild(set);
    });
  }

  function removeContent(e) {
    const cardBody = document.getElementById("contentListCard");
    if (cardBody.childElementCount > 3)
      e.target.parentElement.parentElement.parentElement.remove();
  }

  function unlockPage() {
    const inputList = document.querySelectorAll(
      "input, textarea, select, button, a"
    );
    inputList.forEach(function (inp) {
      inp.disabled = false;
    });
    loadingDiv.style.display = "none";
  }

  function deleteVod() {
    const loadingDiv = document.getElementById("loadingDiv");
    const confirmacao = window.confirm(
      "Deseja excluir este registro de Vod permanentemente?"
    );
    if (confirmacao) {
      // Executa a fun칞칚o de excluir as informa칞칫es do Vod e seus Conteudos da Spreadsheet
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .deleteVodSs(idPag);
      loadingDiv.style.display = "flex";
    }

    function onSuccess() {
      const lDiv1 = document.createElement("div");
      lDiv1.className = "card d-flex justify-content-center";
      const lDiv2 = document.createElement("div");
      lDiv2.className = "card-body text-center";
      const lDiv3a = document.createElement("div");
      lDiv3a.className = "row";
      const lSpana = document.createElement("span");
      lSpana.textContent =
        "A exclus칚o do Vod " +
        numVod +
        " no sistema foi realizada com sucesso!";
      lDiv3a.appendChild(lSpana);
      lDiv2.appendChild(lDiv3a);
      const lDiv3b = document.createElement("div");
      lDiv3b.className = "row";
      const lSpanb = document.createElement("span");
      lSpanb.appendChild(document.createTextNode("Retornar para a "));
      const lA = document.createElement("a");
      lA.setAttribute("href", pageUrl);
      lA.classList = "text-decoration-none fw-bold text-cherry";
      lA.textContent = "P치gina Inicial";
      lSpanb.appendChild(lA);
      lSpanb.appendChild(document.createTextNode("."));
      lDiv3b.appendChild(lSpanb);
      lDiv2.appendChild(lDiv3b);
      lDiv1.appendChild(lDiv2);
      loadingDiv.textContent = "";
      loadingDiv.appendChild(lDiv1);
      window.top.location.href = pageUrl;
    }

    function onFailure() {
      alert(
        "Infelizmente n칚o foi poss칤vel excluir o Vod do sistema, tente novamente."
      );
    }
  }
</script>
